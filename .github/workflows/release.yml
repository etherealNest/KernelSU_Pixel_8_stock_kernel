name: Create Release

on:
  workflow_run:
    workflows: ["Build kernel with KernelSU/KernelSU-Next integration"]
    types: [completed]
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Build workflow run ID (leave empty for latest)'
        required: false
        type: string

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    env:
      KSU_NEXT_VERSION: ''
      KERNEL_VER: ''
      STABLE_SECURITY_PATCH: ''
      BETA_SECURITY_PATCH: ''
      NANO: ''
    permissions:
      contents: write
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Determine run ID
        id: run-id
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ -n "${{ inputs.run_id }}" ]; then
              echo "value=${{ inputs.run_id }}" >> $GITHUB_OUTPUT
            else
              RUN_ID=$(gh run list --workflow=build-main.yml --status=success --limit=1 --json databaseId --jq '.[0].databaseId')
              echo "value=${RUN_ID}" >> $GITHUB_OUTPUT
            fi
          else
            echo "value=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Download artifacts
        uses: actions/download-artifact@v5
        with:
          path: ./assets
          run-id: ${{ steps.run-id.outputs.value }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Getting enivroments
        run: |
          README_BETA=./assets/AnyKernel3_beta/README.txt
          README_STABLE=./assets/AnyKernel3_stable/README.txt
          
          cat >> $GITHUB_ENV << EOF
          KSU_NEXT_VERSION=$(sed -n 's/.*version: //p' $README_BETA | head -1)
          KERNEL_VER=$(sed -n 's/Linux kernel: //p' $README_STABLE)
          BETA_SECURITY_PATCH=$(sed -n 's/Security patch: //p' $README_BETA)
          STABLE_SECURITY_PATCH=$(sed -n 's/Security patch: //p' $README_STABLE)
          NANO=$(date +%N)
          EOF
        
      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./assets/AnyKernel3_*/*AnyKernel3*.zip
            ./assets/IMG_*/*_boot.img_*.zip
          tag_name: KSU-Next${{ env.KSU_NEXT_VERSION }}_${{ env.KERNEL_VER }}_stable${{ env.STABLE_SECURITY_PATCH }}_beta${{ env.BETA_SECURITY_PATCH }}_${{ env.NANO }}
          prerelease: false
          name: "KSU-Next ${{ env.KSU_NEXT_VERSION }} | ${{ env.KERNEL_VER }}"
          body: |
            ### Info
            **Device:** Google Pixel 8 (shiba) / 8 Pro (husky)
            **Kernel Version:** ${{ env.KERNEL_VER }}
            **Firmware security patch stable / beta**: ${{ env.STABLE_SECURITY_PATCH }} / ${{ env.BETA_SECURITY_PATCH }}

            ### **KernelSU Next Version:** ${{ env.KSU_NEXT_VERSION }}
            **Integrated [Baseband_guard](https://github.com/vc-teahouse/Baseband-guard)**
            **Integrated [KPatch-Next](https://github.com/KernelSU-Next/KPatch-Next)**
            **[SUSFS](https://gitlab.com/simonpunk/susfs4ksu) Version:** v2.0.0

            **GitHub Actions workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ steps.run-id.outputs.value }}

            ---
            
            ### ⚠️ Important
            **Before performing any actions, read README.md on the main repository page.**
            
            ---
            
            ### Installation Guide
            
            [Guide for AnyKernel3 on Github Gist](https://gist.github.com/etherealNest/1ed53fdda401534cd50ee5b866eb3206)
            [Guide for Fastboot on Github Gist](https://gist.github.com/etherealNest/9c34519a0919746a696d19a7c66bf392)
            
            **5. Post-installation steps (After booting):**
            
              ### For KernelSU Next:
              
              1. Download and install [KernelSU Next manager](https://github.com/KernelSU-Next/KernelSU-Next/releases)
              2. Download and install the [SUSFS module](https://github.com/sidex15/susfs4ksu-module)
              3. Download and install a meta-module, for example, [meta-hybrid_mount](https://github.com/Hybrid-Mount/meta-hybrid_mount)
              4. Download and install the [KPatch-Next-Module](https://github.com/KernelSU-Next/KPatch-Next-Module/releases)
              5. Reboot your system to apply changes
              
              ### For KernelSU:
              
              1. Download and install [KernelSU manager](https://github.com/tiann/KernelSU/releases)
              2. Download and install the [SUSFS module](https://github.com/sidex15/susfs4ksu-module)
              3. Download and install a meta-module, for example, [meta-hybrid_mount](https://github.com/Hybrid-Mount/meta-hybrid_mount)
              4. Reboot your system to apply changes
