name: Build logic

on:
  workflow_call:
    inputs:
      variant:
        required: true
        type: string
      beta:
        required: true
        type: string

jobs:
  build:
    name: ${{ inputs.beta }}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
      BUILD_ID: ''
      KERNEL: ''
      DEFCONFIG: ''
      KSU_VERSION: ''
      KERNEL_VER: '' 
      SECURITY_PATCH: ''
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
        run: |
          KERNEL=$(pwd)/kernel_pixel
          DEFCONFIG=$KERNEL/private/devices/google/shusky/shusky_defconfig
          echo "KERNEL=$KERNEL" >> $GITHUB_ENV
          echo "DEFCONFIG=$DEFCONFIG" >> $GITHUB_ENV
          echo "DIST=$KERNEL/out/shusky/dist" >> $GITHUB_ENV

          echo "KSU_NEXT_COMMIT=000852fe2801e75b4750ee8db579eac61c525cae" >> $GITHUB_ENV
          echo "KSU_COMMIT=c44adc14c7fdaf9e7d3de8a32575bf15e1e35206" >> $GITHUB_ENV
          SUSFS_COMMIT=27958412f3faef62f03c78708bc39095c2c77812
          echo "SUSFS_COMMIT=$SUSFS_COMMIT" >> $GITHUB_ENV

          if [ "${{ inputs.beta }}" == "stable" ]; then
            SECURITY_PATCH=2026-02-05
          elif [ "${{ inputs.beta }}" == "beta" ]; then
            SECURITY_PATCH=2026-01-05
          fi
          echo "SECURITY_PATCH=$SECURITY_PATCH" >> $GITHUB_ENV

          git clone https://gitlab.com/grapheneos/kernel_pixel.git -b 16-qpr2 --depth=1 kernel_pixel
          git clone https://android.googlesource.com/kernel/common -b android14-6.1-2025-08 --depth=1 kernel_source
          git clone https://gitlab.com/simonpunk/susfs4ksu --single-branch -b gki-android14-6.1 && cd susfs4ksu && git checkout $SUSFS_COMMIT && cd -
          git clone https://github.com/etherealNest/AnyKernel3 -b stock_zuma --depth=1

          sudo mount --bind kernel_source ${KERNEL}/aosp

          cat >> $DEFCONFIG << EOF
          CONFIG_KSU=y
          CONFIG_KSU_SUSFS=y
          CONFIG_THREAD_INFO_IN_TASK=y
          CONFIG_KALLSYMS=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          EOF

          # –£–¥–∞–ª–µ–Ω–∏–µ ABI –∏ –º–µ—Ç–∫–∏ -dirty
          rm -rf $KERNEL/aosp/android/abi_gki_protected_exports_*
          perl -pi -e 's/^\s*"protected_exports_list"\s*:\s*"android\/abi_gki_protected_exports_aarch64",\s*$//;' $KERNEL/aosp/BUILD.bazel
          sed -i "s/echo -n -dirty/echo -n \"\"/g" $KERNEL/build/kernel/kleaf/workspace_status_stamp.py

          echo "KERNEL_VER=$(sed -n '2,4p' ${KERNEL}/aosp/Makefile | grep -oE '[0-9]+' | paste -sd '.')" >> $GITHUB_ENV

          # –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–±–æ—Ä–∫–∏ –Ω–µ–Ω—É–∂–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
          sed -i 's/build_dtb = True,/build_dtb = False,/' kernel_pixel/private/devices/google/shusky/BUILD.bazel
          sed -i 's/build_dtbo = True,/build_dtbo = False,/' kernel_pixel/private/devices/google/shusky/BUILD.bazel
          sed -i 's/build_system_dlkm = True,/build_system_dlkm = False,/' kernel_pixel/private/devices/google/shusky/BUILD.bazel
          sed -i 's/build_vendor_dlkm = True,/build_vendor_dlkm = False,/' kernel_pixel/private/devices/google/shusky/BUILD.bazel
          sed -i 's/build_vendor_kernel_boot = True,/build_vendor_kernel_boot = False,/' kernel_pixel/private/devices/google/shusky/BUILD.bazel

          sed -i 's/build_dtb = True,/build_dtb = False,/' kernel_pixel/private/devices/google/zuma/BUILD.bazel
          sed -i 's/build_dtbo = True,/build_dtbo = False,/' kernel_pixel/private/devices/google/zuma/BUILD.bazel
          sed -i 's/build_system_dlkm = True,/build_system_dlkm = False,/' kernel_pixel/private/devices/google/zuma/BUILD.bazel
          sed -i 's/build_vendor_dlkm = True,/build_vendor_dlkm = False,/' kernel_pixel/private/devices/google/zuma/BUILD.bazel
          sed -i 's/build_vendor_kernel_boot = True,/build_vendor_kernel_boot = False,/' kernel_pixel/private/devices/google/zuma/BUILD.bazel

      - name: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è KernelSU/KernelSU-Next
        working-directory: kernel_pixel/aosp
        run: |
          curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/dev/kernel/setup.sh" | bash -s dev
          cd KernelSU-Next && git checkout $KSU_NEXT_COMMIT
          BASE_VERSION=30000 && COMMIT_COUNT=$(/usr/bin/git rev-list --count HEAD) && echo "KSU_VERSION=$(expr $COMMIT_COUNT "+" $BASE_VERSION)" >> $GITHUB_ENV
      
      - name: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è SUSFS –∏ –ø–∞—Ç—á–µ–π
        run: |
          cp susfs4ksu/kernel_patches/fs/* $KERNEL/aosp/fs/
          cp susfs4ksu/kernel_patches/include/linux/* $KERNEL/aosp/include/linux/

          echo "  ‚úçüèª –ü–∞—Ç—á —è–¥—Ä–∞"
          patch -d "$KERNEL/aosp" -p1 < susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch || true

          echo "  ‚úçüèª –ü–∞—Ç—á KernelSU/KernelSU-Next"
          patch -d "$KERNEL/aosp/${{ inputs.variant }}" -p1 < susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch || true

          echo "    üõ†Ô∏è –†–µ–º–æ–Ω—Ç –ø–∞—Ç—á–∞ KernelSU/KernelSU-Next"
          PATCH=$GITHUB_WORKSPACE/patches/ksu-next_susfs
          (cd $KERNEL/aosp/KernelSU-Next && sha256sum -c $PATCH/checksum.sha256)
          patch -d "$KERNEL/aosp/KernelSU-Next" -p1 < $PATCH/allowlist.c.patch 
          patch -d "$KERNEL/aosp/KernelSU-Next" -p1 < $PATCH/kernel_umount.c.patch 
          patch -d "$KERNEL/aosp/KernelSU-Next" -p1 < $PATCH/ksu.c.patch 
          patch -d "$KERNEL/aosp/KernelSU-Next" -p1 < $PATCH/ksud.c.patch 
          patch -d "$KERNEL/aosp/KernelSU-Next" -p1 < $PATCH/Makefile.patch 
          patch -d "$KERNEL/aosp/KernelSU-Next" -p1 < $PATCH/sucompat.c.patch 
          patch -d "$KERNEL/aosp/KernelSU-Next" -p1 < $PATCH/supercalls.c.patch 

      - name: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è GrapheneOS —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è c –∏—Å—Ö–æ–¥–Ω—ã–º –∫–æ–¥–æ–º —è–¥—Ä–∞
        run: |
          patch -d $KERNEL -p1 < patches/fix_tcpm.c.patch
          patch -d $KERNEL -p1 < patches/fix_tcpm.h.patch

          sed -i '/tcpm_unregister_port/a \
            tcpm_update_sink_capabilities' $KERNEL/aosp/android/abi_gki_aarch64_pixel
          grep -A 1 'tcpm_unregister_port' $KERNEL/aosp/android/abi_gki_aarch64_pixel

          sed -i '/#endif	\/\* _LINUX_MINMAX_H \*\//i \
          #define MIN(a, b) __cmp(min, a, b)\
          #define MAX(a, b) __cmp(max, a, b)' $KERNEL/aosp/include/linux/minmax.h
          grep -B 2 '#endif	/\* _LINUX_MINMAX_H \*/' $KERNEL/aosp/include/linux/minmax.h

          sed -i '/#define MAX(a, b) ((a) >= (b) ? (a) : (b))/i \
          #ifdef MAX\
          #undef MAX\
          #endif' $KERNEL/aosp/mm/zsmalloc.c
          grep -B 3 '#define MAX(a, b) ((a) >= (b) ? (a) : (b))' $KERNEL/aosp/mm/zsmalloc.c

      - name: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Baseband-guard
        run: |
          (cd $KERNEL/aosp && wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash)
          echo "CONFIG_BBG=y" >> $DEFCONFIG
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/selinux/selinux,baseband_guard/ } }' $KERNEL/aosp/security/Kconfig

      - name: –°–±–æ—Ä–∫–∞
        run: cd $KERNEL && tools/bazel clean --expunge && KLEAF_REPO_MANIFEST=aosp_manifest.xml ./build_shusky.sh --config=fast --lto=thin --keep_going

      - name: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–æ–≤ AnyKernel3
        run: |
          ZIP_NAME="${{ env.KERNEL_VER }}_AnyKernel3_zuma(Pixel8or8Pro)_${{ inputs.variant }}_${{ inputs.beta }}.zip"
          AK_OUT=anykernel/output
          
          mkdir -p ${AK_OUT} KPatch-Next
          
          cd KPatch-Next
          gh release download --repo KernelSU-Next/KPatch-Next -p 'kpimg-linux' -p 'kptools-linux' --clobber
          chmod +x kptools-linux
          cd -
          
          KPatch-Next/kptools-linux -p -i ${DIST}/Image -k KPatch-Next/kpimg-linux -o ${DIST}/Image_patched
          mv -f ${DIST}/Image_patched ${DIST}/Image
          
          cp -r AnyKernel3/* ${AK_OUT}
          cp ${DIST}/Image ${AK_OUT}
          
          sed -i 's/supported\.vendorpatchlevels=/&${{ env.SECURITY_PATCH}}/' ${AK_OUT}/anykernel.sh
          
          cd ${AK_OUT}
          zip -rm "${ZIP_NAME}" *
          cd -
          
          cat >> ${AK_OUT}/README.txt << EOF
          ##########Source##########
          [https://github.com/etherealNest/KernelSU_Pixel_8_stock_kernel](https://github.com/etherealNest/KernelSU_Pixel_8_stock_kernel)
          ###########Info###########
          Device: Pixel 8/Pro
          Codename: shiba/husky
          Linux kernel: ${{ env.KERNEL_VER }}
          ${{ inputs.variant }} version: ${{ env.KSU_VERSION }}
          SUSFS: v2.0.0
          Build-in Baseband-guard
          ####Kernel created for####
          Security patch: ${{ env.SECURITY_PATCH }}
          Type firmware: stock ${{ inputs.beta }}
          ##########################
          EOF

      - name: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        run: |
          mkdir -p output && cp ${DIST}/boot.img output/
          
          mkdir -p KPatch-Next
          cd KPatch-Next
          gh release download v30.2 --repo topjohnwu/Magisk -p 'Magisk*.apk' --clobber
          unzip -oj Magisk*.apk lib/x86_64/libmagiskboot.so
          mv -f libmagiskboot.so magiskboot
          chmod +x magiskboot
          
          cd ../output
          ../KPatch-Next/magiskboot unpack boot.img
          cp -f ${DIST}/Image ./kernel
          ../KPatch-Next/magiskboot repack boot.img boot_patched.img
          mv -f boot_patched.img boot.img
          rm -rf *kernel* ramdisk* header* dtb* unknown*
          
          cat >> README.txt << EOF
          ##########Source##########
          [https://github.com/etherealNest/KernelSU_Pixel_8_stock_kernel](https://github.com/etherealNest/KernelSU_Pixel_8_stock_kernel)
          ###########Info###########
          Device: Pixel 8/Pro
          Codename: shiba/husky
          Linux kernel: ${{ env.KERNEL_VER }}
          ${{ inputs.variant }} version: ${{ env.KSU_VERSION }}
          SUSFS: v2.0.0
          Build-in Baseband-guard
          ####Kernel created for####
          Security patch: ${{ env.SECURITY_PATCH }}
          Type firmware: stock ${{ inputs.beta }}
          ##########################
          EOF

          BOOT_ZIP_NAME="${{ env.KERNEL_VER }}_boot.img_${{ inputs.variant }}_${{ inputs.beta }}.zip"
          zip -m "$BOOT_ZIP_NAME" boot.img README.txt
          
          cd -

      - name: Upload AnyKernel3 Artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: AnyKernel3_${{ inputs.beta }}
          path: anykernel/output/*

      - name: Upload Boot Image Artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: IMG_${{ inputs.beta }}
          path: output/*.zip
