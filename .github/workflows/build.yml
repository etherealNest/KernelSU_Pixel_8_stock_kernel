name: Build logic

on:
  workflow_call:
    inputs:
      variant:
        required: true
        type: string
      beta:
        required: true
        type: string

jobs:
  build:
    name: ${{ inputs.beta }}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
      BUILD_ID: ''
      KERNEL: ''
      DEFCONFIG: ''
      KSU_VERSION: ''
      KERNEL_VER: '' 
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
        run: |
          KERNEL=$(pwd)/kernel_pixel
          DEFCONFIG=$KERNEL/private/devices/google/shusky/shusky_defconfig
          echo "KERNEL=$KERNEL" >> $GITHUB_ENV
          echo "DEFCONFIG=$DEFCONFIG" >> $GITHUB_ENV
          echo "DIST=$KERNEL/out/shusky/dist" >> $GITHUB_ENV

          echo "KSU_NEXT_COMMIT=6aa18400f7277ed3d0d0f30ea97f1b437a235cd3" >> $GITHUB_ENV
          echo "KSU_COMMIT=c44adc14c7fdaf9e7d3de8a32575bf15e1e35206" >> $GITHUB_ENV
          SUSFS_COMMIT=700af50a692ec8a7279bce005ffce0f91195eab1
          echo "SUSFS_COMMIT=$SUSFS_COMMIT" >> $GITHUB_ENV

          if [ "${{ inputs.beta }}" == "stable" ]; then
            SECURITY_PATCH=2026-01
            PROP=google/shiba/shiba:16/BP4A.260205.001/14624666:user/release-keys
          elif [ "${{ inputs.beta }}" == "beta" ]; then
            SECURITY_PATCH=2026-01
            PROP=google/shiba_beta/shiba:16/CP11.251209.009.A1/14840729:user/release-keys
          fi
          echo "SECURITY_PATCH=$SECURITY_PATCH" >> $GITHUB_ENV
          echo "PROP=$PROP" >> $GITHUB_ENV
          echo "BUILD_ID=$(echo $PROP | cut -d'/' -f4)" >> $GITHUB_ENV

          git clone https://gitlab.com/grapheneos/kernel_pixel.git -b 16-qpr2 --depth=1 kernel_pixel
          git clone https://android.googlesource.com/kernel/common -b android14-6.1-2025-08 --depth=1 kernel_source
          git clone https://gitlab.com/simonpunk/susfs4ksu -b gki-android14-6.1 && cd susfs4ksu && git checkout $SUSFS_COMMIT && cd -
          git clone https://github.com/etherealNest/AnyKernel3 -b stock_zuma --depth=1

          sudo mount --bind kernel_source ${KERNEL}/aosp

          cat >> $DEFCONFIG << EOF
          CONFIG_KSU=y
          CONFIG_KSU_SUSFS=y
          CONFIG_THREAD_INFO_IN_TASK=y
          CONFIG_KALLSYMS=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          EOF

          # –£–¥–∞–ª–µ–Ω–∏–µ ABI –∏ –º–µ—Ç–∫–∏ -dirty
          rm -rf $KERNEL/aosp/android/abi_gki_protected_exports_*
          perl -pi -e 's/^\s*"protected_exports_list"\s*:\s*"android\/abi_gki_protected_exports_aarch64",\s*$//;' $KERNEL/aosp/BUILD.bazel
          sed -i "s/echo -n -dirty/echo -n \"\"/g" $KERNEL/build/kernel/kleaf/workspace_status_stamp.py

          echo "KERNEL_VER=$(sed -n '2,4p' ${KERNEL}/aosp/Makefile | grep -oE '[0-9]+' | paste -sd '.')" >> $GITHUB_ENV

      - name: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è KernelSU/KernelSU-Next
        working-directory: kernel_pixel/aosp
        run: |
          if [ ${{ inputs.variant }} == "KernelSU-Next" ]; then
            curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/dev/kernel/setup.sh" | bash -s dev
            cd KernelSU-Next && git checkout $KSU_NEXT_COMMIT
            BASE_VERSION=30000 && COMMIT_COUNT=$(/usr/bin/git rev-list --count HEAD) && echo "KSU_VERSION=$(expr $COMMIT_COUNT "+" $BASE_VERSION)" >> $GITHUB_ENV
          elif [ ${{ inputs.variant }} == "KernelSU" ]; then
            curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
            cd KernelSU && git checkout $KSU_COMMIT
            BASE_VERSION=30000 && COMMIT_COUNT=$(/usr/bin/git rev-list --count HEAD) && echo "KSU_VERSION=$(expr $COMMIT_COUNT "+" $BASE_VERSION)" >> $GITHUB_ENV
          fi
      
      - name: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è SUSFS –∏ –ø–∞—Ç—á–µ–π
        run: |
          cp susfs4ksu/kernel_patches/fs/* $KERNEL/aosp/fs/
          cp susfs4ksu/kernel_patches/include/linux/* $KERNEL/aosp/include/linux/

          echo "  ‚úçüèª –ü–∞—Ç—á —è–¥—Ä–∞"
          patch -d "$KERNEL/aosp" -p1 < susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch || true
          echo "    üõ†Ô∏è –†–µ–º–æ–Ω—Ç –ø–∞—Ç—á–∞ —è–¥—Ä–∞"
          patch -d "$KERNEL/aosp" -p1 < patches/base.c.patch

          echo "  ‚úçüèª –ü–∞—Ç—á KernelSU/KernelSU-Next"
          patch -d "$KERNEL/aosp/${{ inputs.variant }}" -p1 < susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch || true
          if [ ${{ inputs.variant }} == "KernelSU-Next" ]; then
            echo "    üõ†Ô∏è –†–µ–º–æ–Ω—Ç –ø–∞—Ç—á–∞ KernelSU/KernelSU-Next"
            PATCH=$GITHUB_WORKSPACE/patches/ksu-next_susfs
            (cd $KERNEL/aosp/KernelSU-Next && sha256sum -c $PATCH/checksum.sha256)
            patch -d "$KERNEL/aosp/KernelSU-Next" -p1 < $PATCH/allowlist.c.patch 
            patch -d "$KERNEL/aosp/KernelSU-Next" -p1 < $PATCH/kernel_umount.c.patch 
            patch -d "$KERNEL/aosp/KernelSU-Next" -p1 < $PATCH/ksu.c.patch 
            patch -d "$KERNEL/aosp/KernelSU-Next" -p1 < $PATCH/ksud.c.patch 
            patch -d "$KERNEL/aosp/KernelSU-Next" -p1 < $PATCH/Makefile.patch 
            patch -d "$KERNEL/aosp/KernelSU-Next" -p1 < $PATCH/sucompat.c.patch 
            patch -d "$KERNEL/aosp/KernelSU-Next" -p1 < $PATCH/supercalls.c.patch 
          fi
      - name: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è GrapheneOS —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è c –∏—Å—Ö–æ–¥–Ω—ã–º –∫–æ–¥–æ–º —è–¥—Ä–∞
        run: |
          patch -d $KERNEL -p1 < patches/fix_tcpm.c.patch
          patch -d $KERNEL -p1 < patches/fix_tcpm.h.patch

          sed -i '/tcpm_unregister_port/a \
            tcpm_update_sink_capabilities' $KERNEL/aosp/android/abi_gki_aarch64_pixel
          grep -A 1 'tcpm_unregister_port' $KERNEL/aosp/android/abi_gki_aarch64_pixel

          sed -i '/#endif	\/\* _LINUX_MINMAX_H \*\//i \
          #define MIN(a, b) __cmp(min, a, b)\
          #define MAX(a, b) __cmp(max, a, b)' $KERNEL/aosp/include/linux/minmax.h
          grep -B 2 '#endif	/\* _LINUX_MINMAX_H \*/' $KERNEL/aosp/include/linux/minmax.h

          sed -i '/#define MAX(a, b) ((a) >= (b) ? (a) : (b))/i \
          #ifdef MAX\
          #undef MAX\
          #endif' $KERNEL/aosp/mm/zsmalloc.c
          grep -B 3 '#define MAX(a, b) ((a) >= (b) ? (a) : (b))' $KERNEL/aosp/mm/zsmalloc.c

      - name: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Baseband-guard
        run: |
          (cd $KERNEL/aosp && wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash)
          echo "CONFIG_BBG=y" >> $DEFCONFIG
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/selinux/selinux,baseband_guard/ } }' $KERNEL/aosp/security/Kconfig

      - name: –°–±–æ—Ä–∫–∞
        run: cd $KERNEL && tools/bazel clean --expunge && KLEAF_REPO_MANIFEST=aosp_manifest.xml ./build_shusky.sh --config=fast --lto=thin --keep_going

      - name: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–æ–≤ AnyKernel3
        run: |
          ZIP_NAME=${{ env.KERNEL_VER }}_AnyKernel3_zuma_${{ inputs.variant }}_${{ inputs.beta }}.zip
          mkdir -p anykernel/output && cp ${DIST}/vendor_kernel_boot.img anykernel/output
          curl -s "https://android.googlesource.com/platform/system/tools/mkbootimg/+/refs/heads/main/unpack_bootimg.py?format=TEXT" | base64 -d > unpack_bootimg.py && chmod +x unpack_bootimg.py
          mkdir tmp && ./unpack_bootimg.py --boot_img anykernel/output/vendor_kernel_boot.img --out tmp && cp tmp/dtb anykernel/output && rm -rf tmp/*
          cp -r AnyKernel3/* anykernel/output
          
          mkdir -p KPatch-Next && cd KPatch-Next
          gh release download --repo KernelSU-Next/KPatch-Next -p 'kpimg-linux' -p 'kptools-linux' --clobber && chmod +x kptools-linux
          export PATH="$(pwd):$PATH" && KPATCH=$(pwd) && cd -
          kptools-linux -p -i ${DIST}/Image -k ${KPATCH}/kpimg-linux -o ${DIST}/Image_patched && mv -f ${DIST}/Image_patched ${DIST}/Image
          
          cp ${DIST}/Image anykernel/output
          rm -rf anykernel/output/*.img
          sed -i 's/supported\.vendorpatchlevels=/&${{ env.SECURITY_PATCH}}/' anykernel/output/anykernel.sh
          cd anykernel/output && zip -rm ${ZIP_NAME} * && cd -

          cat >> anykernel/output/README.txt << EOF
          ##########Source##########
          https://github.com/etherealNest/KernelSU_Pixel_8_stock_kernel
          ###########Info###########
          Device: Pixel 8/Pro
          Codename: shiba/husky
          Linux kernel: ${{ env.KERNEL_VER }}
          ${{ inputs.variant }} version: ${{ env.KSU_VERSION }}
          SUSFS: v2.0.0
          Build-in Baseband-guard
          ####Kernel created for####
          Security patch: ${{ env.SECURITY_PATCH }}
          Type firmware: stock ${{ inputs.beta }}
          ##########################
          EOF

      - name: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        run: |
          mkdir output_shiba && cp ${DIST}/boot.img \
          ${DIST}/vendor_kernel_boot.img \
          ${DIST}/dtbo.img \
          ${DIST}/system_dlkm.img \
          ${DIST}/vendor_dlkm.img \
          ./output_shiba

          if [ KernelSU-Next == "KernelSU-Next" ]; then
            cd KPatch-Next
            gh release download v30.2 --repo topjohnwu/Magisk -p 'Magisk*.apk' --clobber
            unzip -j Magisk*.apk lib/x86_64/libmagiskboot.so && mv libmagiskboot.so magiskboot
            chmod +x kptools-linux && chmod +x magiskboot
            export PATH="$(pwd):$PATH"
            cd -
            
            mkdir -p output_shiba/tmp && cd output_shiba/tmp
            magiskboot unpack ../boot.img
            cp -f ${DIST}/Image ./kernel
            magiskboot repack ../boot.img ../boot_patched.img
            mv -f ../boot_patched.img ../boot.img && rm -rf ../tmp && cd -
          fi

          mkdir output_husky && cp -r output_shiba/* output_husky

          curl -s "https://android.googlesource.com/platform/external/avb/+/master/avbtool.py?format=TEXT" | base64 -d > avbtool.py && chmod +x avbtool.py

          ./avbtool.py add_hash_footer \
            --image output_shiba/vendor_kernel_boot.img \
            --partition_name vendor_kernel_boot \
            --partition_size 0x4000000 \
            --hash_algorithm sha256 \
            --prop com.android.build.vendor_kernel_boot.fingerprint:"$PROP"
          ./avbtool.py add_hash_footer \
            --image output_shiba/dtbo.img \
            --partition_name dtbo \
            --partition_size 0x1000000 \
            --hash_algorithm sha256 \
            --prop com.android.build.dtbo.fingerprint:"$PROP"

          ./avbtool.py add_hash_footer \
            --image output_husky/vendor_kernel_boot.img \
            --partition_name vendor_kernel_boot \
            --partition_size 0x4000000 \
            --hash_algorithm sha256 \
            --prop com.android.build.vendor_kernel_boot.fingerprint:"${PROP//shiba/husky}"
          ./avbtool.py add_hash_footer \
            --image output_husky/dtbo.img \
            --partition_name dtbo \
            --partition_size 0x1000000 \
            --hash_algorithm sha256 \
            --prop com.android.build.dtbo.fingerprint:"${PROP//shiba/husky}"

          cat >> output_shiba/README.txt << EOF
          ##########Source##########
          https://github.com/etherealNest/KernelSU_Pixel_8_stock_kernel
          ###########Info###########
          Device: Pixel 8
          Codename: shiba
          Linux kernel: ${{ env.KERNEL_VER }}
          ${{ inputs.variant }} version: ${{ env.KSU_VERSION }}
          SUSFS: v2.0.0
          Build-in Baseband-guard
          ####Kernel created for####
          Firmware Build ID: ${{ env.BUILD_ID }}
          Type firmware: stock ${{ inputs.beta }}
          ##########################
          EOF

          cat >> output_husky/README.txt << EOF
          ##########Source##########
          https://github.com/etherealNest/KernelSU_Pixel_8_stock_kernel
          ###########Info###########
          Device: Pixel 8 Pro
          Codename: husky
          Linux kernel: ${{ env.KERNEL_VER }}
          ${{ inputs.variant }} version: ${{ env.KSU_VERSION }}
          SUSFS version: v2.0.0
          Build-in Baseband-guard
          ####Kernel created for####  
          Firmware Build ID: ${{ env.BUILD_ID }}
          Type firmware: stock ${{ inputs.beta }}
          ##########################
          EOF

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: AnyKernel3_${{ inputs.beta }}
          path: anykernel/output/*

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: ${{ env.KERNEL_VER }}_shiba(Pixel-8)_${{ inputs.variant }}_${{ inputs.beta }}_${{ env.BUILD_ID }}
          path: output_shiba/*

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: ${{ env.KERNEL_VER }}_husky(Pixel-8-Pro)_${{ inputs.variant }}_${{ inputs.beta }}_${{ env.BUILD_ID }}
          path: output_husky/*